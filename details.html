<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>ببینتو · جزئیات</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="author" content="Arya Azadeh" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"
    ></script>

    <script
      type="module"
      src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js"
    ></script>

    <link rel="shortcut icon" href="favicon.webp" type="image/x-icon" />

    <style>
      [x-cloak] {
        display: none !important;
      }
      button,
      a {
        cursor: pointer;
      }
      @media (prefers-reduced-motion: reduce) {
        .motion-safe-anim {
          transition: none !important;
          animation: none !important;
        }
      }
      @media (max-width: 1024px) {
        input,
        textarea,
        select {
          font-size: 16px;
        }
      }

      /* Skeleton shimmer */
      .shimmer {
        position: relative;
        overflow: hidden;
      }
      .shimmer::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(100%);
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        animation: shimmer 1.1s infinite;
      }
      @keyframes shimmer {
        100% {
          transform: translateX(-100%);
        }
      }
      @media (prefers-reduced-motion: reduce) {
        .shimmer::after {
          animation: none !important;
        }
      }
    </style>

    <style type="text/tailwindcss">
      @theme {
        --font-sans: "Vazirmatn", system-ui, sans-serif;
        --font-heading: "Vazirmatn", sans-serif;

        --color-bg: #09090b;
        --color-surface: #18181b;
        --color-surface-highlight: #27272a;

        --color-text-primary: #f4f4f5;
        --color-text-secondary: #a1a1aa;

        --color-border: #27272a;

        --color-accent: #10b981;
        --color-accent-text: #020617;
      }

      html.light {
        --color-bg: #f4f4f5;
        --color-surface: #ffffff;
        --color-surface-highlight: #f4f4f5;

        --color-text-primary: #18181b;
        --color-text-secondary: #52525b;

        --color-border: #e4e4e7;

        --color-accent: #0f766e;
        --color-accent-text: #ffffff;
      }

      @layer utilities {
        .custom-scrollbar::-webkit-scrollbar {
          width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background-color: #3f3f46;
          border-radius: 9999px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background-color: #52525b;
        }
        .light .custom-scrollbar::-webkit-scrollbar-thumb {
          background-color: #d4d4d8;
        }
        .light .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background-color: #a1a1aa;
        }

        .hide-scrollbar::-webkit-scrollbar {
          display: none;
        }
        .hide-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
      }
    </style>
  </head>

  <body
    x-data="BebintoDetailsApp()"
    x-init="init()"
    @scroll.window="showBackToTop = (window.scrollY > 400)"
    @keydown.escape.window="handleEscape()"
    class="bg-bg text-text-primary font-sans antialiased selection:bg-accent selection:text-accent-text"
  >
    <div class="min-h-screen flex flex-col pb-28 lg:pb-0">
      <!-- Mobile Header -->
      <div
        class="lg:hidden sticky top-0 z-40 bg-bg/70 backdrop-blur-xl border-b border-border"
      >
        <div class="px-4 py-2 flex items-center justify-between gap-3">
          <button
            type="button"
            @click="haptic('light'); goBack()"
            class="inline-flex items-center gap-2 text-sm font-semibold text-text-secondary hover:text-text-primary transition-colors"
            aria-label="بازگشت"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"
              />
            </svg>
            بازگشت
          </button>

          <a
            href="./index.html"
            class="flex items-center gap-2 shrink-0"
            aria-label="خانه"
          >
            <div
              class="h-9 w-9 rounded-2xl bg-zinc-900 flex items-center justify-center shadow overflow-hidden"
            >
              <dotlottie-wc
                src="https://lottie.host/da80b7f6-c288-48b9-a3dc-376f9d276f06/W739BOuqrX.lottie"
                style="width: 40px; height: 40px"
                autoplay
                loop
              ></dotlottie-wc>
            </div>
            <span class="text-sm font-bold">ببینتو</span>
          </a>

          <button
            type="button"
            @click="haptic('light'); toggleTheme()"
            class="w-12 h-6 relative rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-accent/80"
            :class="theme === 'light' ? 'bg-zinc-300' : 'bg-zinc-700'"
            :aria-label="theme === 'dark' ? 'تغییر به حالت روشن' : 'تغییر به حالت تاریک'"
          >
            <span
              class="absolute top-1 left-1 w-4 h-4 rounded-full transition-transform duration-300 ease-in-out bg-white"
              :class="theme === 'light' ? 'translate-x-6' : 'translate-x-0'"
            ></span>
          </button>
        </div>
      </div>

      <div class="flex-grow flex justify-center p-4 sm:p-6 lg:p-8">
        <div
          class="w-full max-w-screen-2xl grid gap-8 lg:grid-cols-[340px_1fr]"
        >
          <!-- Sidebar Desktop -->
          <aside class="hidden lg:block">
            <!-- ✅ sticky: poster + quick info -->
            <div class="space-y-4 lg:sticky lg:top-8 h-fit">
              <div class="flex items-center justify-between gap-3 mb-2">
                <a
                  href="./index.html"
                  class="flex items-center gap-3 group min-w-0"
                  aria-label="خانه"
                >
                  <div
                    class="h-10 w-10 rounded-2xl bg-zinc-900 flex items-center justify-center shadow-lg overflow-hidden"
                  >
                    <dotlottie-wc
                      src="https://lottie.host/da80b7f6-c288-48b9-a3dc-376f9d276f06/W739BOuqrX.lottie"
                      style="width: 44px; height: 44px"
                      autoplay
                      loop
                    ></dotlottie-wc>
                  </div>
                  <div class="min-w-0">
                    <div class="text-lg font-bold font-heading tracking-tight">
                      ببینتو
                    </div>
                    <div class="text-xs text-text-secondary">
                      جزئیات فیلم / سریال
                    </div>
                  </div>
                </a>

                <button
                  type="button"
                  @click="haptic('light'); toggleTheme()"
                  class="w-12 h-6 relative rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-accent/80 shrink-0"
                  :class="theme === 'light' ? 'bg-zinc-300' : 'bg-zinc-700'"
                  :aria-label="theme === 'dark' ? 'تغییر به حالت روشن' : 'تغییر به حالت تاریک'"
                >
                  <span
                    class="absolute top-1 left-1 w-4 h-4 rounded-full transition-transform duration-300 ease-in-out bg-white"
                    :class="theme === 'light' ? 'translate-x-6' : 'translate-x-0'"
                  ></span>
                </button>
              </div>

              <button
                type="button"
                @click="haptic('light'); goBack()"
                class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-surface border border-border hover:bg-surface-highlight transition-colors text-sm font-semibold"
                aria-label="بازگشت"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 8l4 4m0 0l-4 4m4-4H3"
                  />
                </svg>
                بازگشت
              </button>

              <!-- Poster -->
              <div
                class="relative rounded-2xl overflow-hidden border border-border bg-surface-highlight/40 shadow-2xl shadow-black/30"
              >
                <div class="aspect-[2/3] relative">
                  <!-- ✅ Skeleton shimmer تا زمان لود -->
                  <div
                    x-show="!posterLoaded"
                    x-cloak
                    class="absolute inset-0 bg-surface-highlight/60 shimmer"
                    aria-hidden="true"
                  ></div>

                  <img
                    x-ref="posterImg"
                    :src="posterSrc"
                    class="absolute inset-0 w-full h-full object-cover transition-opacity duration-300"
                    :class="posterLoaded ? 'opacity-100' : 'opacity-0'"
                    loading="lazy"
                    @load="handlePosterLoad()"
                    @error="handlePosterError()"
                    :alt="displayTitle(item)"
                  />
                </div>

                <div class="absolute top-3 right-3 flex items-center gap-2">
                  <template x-if="item?.imdb">
                    <div
                      class="flex items-center gap-1 bg-yellow-400 text-black font-bold text-xs px-2 py-1 rounded-full shadow-lg"
                    >
                      <span>IMDb</span>
                      <span x-text="item.imdb"></span>
                    </div>
                  </template>

                  <template
                    x-if="item?.classification && item.classification !== 'N/A'"
                  >
                    <div
                      class="bg-black/60 backdrop-blur text-white text-xs px-2 py-1 rounded-full border border-white/10 shadow-sm"
                      x-text="item.classification"
                    ></div>
                  </template>
                </div>

                <button
                  type="button"
                  @click="haptic('light'); item && toggleWatchlist(item.id)"
                  class="absolute top-3 left-3 z-10 p-2 rounded-full bg-black/50 backdrop-blur-sm text-white hover:bg-accent hover:text-accent-text transition-colors"
                  :aria-label="item && isInWatchlist(item.id) ? 'حذف از لیست من' : 'افزودن به لیست من'"
                >
                  <svg
                    class="w-6 h-6"
                    :class="{'fill-current text-red-500': item && isInWatchlist(item.id)}"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 21l-7.682-7.318a4.5 4.5 0 010-6.364z"
                    ></path>
                  </svg>
                </button>
              </div>

              <!-- Quick info -->
              <div
                class="p-4 rounded-2xl bg-surface border border-border space-y-2"
              >
                <div class="flex items-center justify-between">
                  <div class="text-xs text-text-secondary">اطلاعات سریع</div>
                </div>

                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div
                    class="p-3 rounded-2xl bg-surface-highlight/40 border border-border"
                  >
                    <div class="text-xs text-text-secondary">سال</div>
                    <div
                      class="font-bold mt-1"
                      x-text="item?.year || '—'"
                    ></div>
                  </div>

                  <div
                    class="p-3 rounded-2xl bg-surface-highlight/40 border border-border"
                  >
                    <div class="text-xs text-text-secondary">کشور</div>
                    <div
                      class="font-bold mt-1 truncate"
                      :title="displayCountry(item)"
                      x-text="displayCountry(item) || '—'"
                    ></div>
                  </div>

                  <template x-if="item?.durationText">
                    <div
                      class="p-3 rounded-2xl bg-surface-highlight/40 border border-border col-span-2"
                    >
                      <div
                        class="text-xs text-text-secondary"
                        x-text="type==='series' ? 'مدت/فصل' : 'مدت'"
                      ></div>
                      <div
                        class="font-bold mt-1"
                        x-text="item.durationText"
                      ></div>
                    </div>
                  </template>

                  <template x-if="item?.rating">
                    <div
                      class="p-3 rounded-2xl bg-surface-highlight/40 border border-border col-span-2"
                    >
                      <div class="text-xs text-text-secondary">
                        امتیاز برنامه
                      </div>
                      <div class="font-bold mt-1 flex items-center gap-2">
                        <span aria-hidden="true">⭐</span>
                        <span x-text="item.rating"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </aside>

          <!-- MAIN -->
          <main class="min-w-0">
            <!-- Hero -->
            <section
              class="relative overflow-hidden rounded-2xl border border-border bg-surface shadow-2xl shadow-black/20"
            >
              <div class="absolute inset-0">
                <div
                  class="absolute inset-0 bg-center bg-cover scale-110 blur-2xl opacity-35"
                  :style="heroBackdropStyle()"
                  aria-hidden="true"
                ></div>
                <div
                  class="absolute inset-0 bg-gradient-to-t from-bg via-bg/70 to-bg/30"
                  aria-hidden="true"
                ></div>
              </div>

              <div class="relative p-4 sm:p-6 lg:p-7">
                <div class="flex items-center justify-between gap-3">
                  <div
                    class="flex items-center gap-2 text-xs text-text-secondary"
                  >
                    <span
                      class="px-2 py-1 rounded-full bg-surface-highlight/60 border border-border"
                      x-text="type === 'series' ? 'سریال' : 'فیلم'"
                    ></span>
                    <span x-text="item?.year || '—'"></span>

                    <template x-if="item?.imdb">
                      <span class="inline-flex items-center gap-2">
                        <span
                          class="w-1 h-1 rounded-full bg-text-secondary/50"
                        ></span>
                        <span
                          class="font-bold bg-yellow-400 text-black px-2 py-0.5 rounded-full"
                          >IMDb <span x-text="item.imdb"></span
                        ></span>
                      </span>
                    </template>
                  </div>

                  <!-- mobile small hint -->
                  <div
                    class="lg:hidden text-xs text-text-secondary"
                    x-text="isMovie ? 'برای دانلود پایین برو' : 'فصل‌ها پایین هستند'"
                  ></div>
                </div>

                <!-- Skeleton -->
                <template x-if="loading">
                  <div
                    class="mt-6 grid gap-6 lg:grid-cols-[260px_1fr] animate-pulse"
                  >
                    <div
                      class="aspect-[2/3] rounded-2xl bg-surface-highlight/60"
                    ></div>
                    <div class="space-y-4">
                      <div
                        class="h-8 rounded-2xl bg-surface-highlight/60 w-3/4"
                      ></div>
                      <div
                        class="h-4 rounded-2xl bg-surface-highlight/60 w-1/2"
                      ></div>
                      <div
                        class="h-24 rounded-2xl bg-surface-highlight/60"
                      ></div>
                      <div
                        class="h-24 rounded-2xl bg-surface-highlight/60"
                      ></div>
                    </div>
                  </div>
                </template>

                <!-- Error -->
                <template x-if="!loading && error">
                  <div
                    class="mt-6 p-4 sm:p-6 rounded-2xl bg-red-950/30 border border-red-800/50"
                  >
                    <div class="flex items-start gap-3">
                      <div
                        class="w-10 h-10 rounded-2xl bg-red-900/40 flex items-center justify-center"
                      >
                        ⚠️
                      </div>
                      <div class="min-w-0">
                        <div class="font-bold">خطا</div>
                        <p
                          class="text-sm text-red-200/90 mt-1"
                          x-text="error"
                        ></p>
                        <div class="mt-4 flex flex-wrap gap-2">
                          <a
                            href="./index.html"
                            class="inline-flex items-center justify-center px-4 py-2 rounded-2xl bg-accent text-accent-text font-bold hover:opacity-90 transition-opacity"
                          >
                            بازگشت به خانه
                          </a>
                          <button
                            type="button"
                            @click="haptic('light'); goBack()"
                            class="inline-flex items-center justify-center px-4 py-2 rounded-2xl bg-surface border border-border hover:bg-surface-highlight transition-colors font-semibold"
                          >
                            برگشت
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- Main -->
                <template x-if="!loading && item && !error">
                  <div class="mt-6">
                    <div class="flex items-start justify-between gap-4">
                      <div class="min-w-0">
                        <h1
                          class="text-2xl sm:text-3xl lg:text-4xl font-bold font-heading tracking-tight"
                          x-text="displayTitle(item)"
                        ></h1>
                        <template x-if="item.original_title">
                          <p
                            class="text-sm text-text-secondary mt-2 truncate"
                            x-text="item.original_title"
                          ></p>
                        </template>

                        <div class="mt-4 flex flex-wrap gap-2">
                          <template x-for="g in displayGenres(item)" :key="g">
                            <span
                              class="text-xs text-text-secondary bg-surface-highlight px-3 py-1 rounded-full border border-border"
                              x-text="g"
                            ></span>
                          </template>
                        </div>
                      </div>

                      <!-- Desktop watchlist quick -->
                      <button
                        type="button"
                        @click="haptic('light'); toggleWatchlist(item.id)"
                        class="hidden lg:inline-flex p-2 rounded-full hover:bg-surface-highlight transition-colors"
                        :aria-label="isInWatchlist(item.id) ? 'حذف از لیست من' : 'افزودن به لیست من'"
                      >
                        <svg
                          class="w-7 h-7"
                          :class="isInWatchlist(item.id) ? 'fill-current text-red-500' : 'text-text-secondary'"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 21l-7.682-7.318a4.5 4.5 0 010-6.364z"
                          ></path>
                        </svg>
                      </button>
                    </div>

                    <!-- Plot -->
                    <section
                      x-show="plotText(item)"
                      class="mt-6 p-4 sm:p-5 rounded-2xl bg-surface border border-border"
                    >
                      <div class="flex items-center justify-between mb-2">
                        <h2 class="text-base font-bold">خلاصه داستان</h2>
                        <span
                          class="text-xs text-text-secondary"
                          x-text="type==='series' ? 'سریال' : 'فیلم'"
                        ></span>
                      </div>
                      <p
                        class="text-sm leading-7 text-text-primary whitespace-pre-line"
                        x-text="plotText(item)"
                      ></p>
                    </section>

                    <!-- Meta -->
                    <section
                      x-show="metaLines(item).length"
                      class="mt-6 p-4 sm:p-5 rounded-2xl bg-surface border border-border"
                    >
                      <h2 class="text-base font-bold mb-3">اطلاعات بیشتر</h2>
                      <ul class="space-y-2 text-sm">
                        <template
                          x-for="(line, idx) in metaLines(item)"
                          :key="idx"
                        >
                          <li
                            class="pb-2 border-b border-border last:border-0 last:pb-0"
                            x-text="line"
                          ></li>
                        </template>
                      </ul>
                    </section>

                    <!-- ✅ Movie downloads ONLY here (no duplicate) -->
                    <template
                      x-if="type==='movie' && Array.isArray(item.sources) && item.sources.length"
                    >
                      <section
                        id="downloadsSection"
                        class="mt-6 p-4 sm:p-5 rounded-2xl bg-surface border border-border"
                      >
                        <div class="flex items-center justify-between">
                          <h2 class="text-base font-bold">لینک‌های دانلود</h2>
                          <span
                            class="text-xs text-text-secondary"
                            x-text="item.sources.length + ' مورد'"
                          ></span>
                        </div>

                        <div class="mt-3 grid gap-2 sm:grid-cols-2">
                          <template
                            x-for="src in item.sources"
                            :key="'dl-'+(src.id || src.url)"
                          >
                            <a
                              :href="src.url"
                              target="_blank"
                              rel="noopener"
                              class="group flex items-center justify-between gap-3 text-sm px-3 py-3 rounded-2xl bg-surface-highlight/40 hover:bg-accent hover:text-accent-text transition-colors border border-border"
                            >
                              <div class="min-w-0 flex items-center gap-2">
                                <span
                                  class="font-bold text-accent group-hover:text-accent-text transition-colors"
                                  x-text="src.quality || 'کیفیت'"
                                ></span>
                                <span
                                  class="text-xs text-text-secondary group-hover:text-accent-text/90 transition-colors"
                                  x-text="(src.type || '').toUpperCase()"
                                ></span>
                              </div>
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-5 h-5 text-text-secondary group-hover:text-accent-text transition-colors"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                                aria-hidden="true"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                                />
                              </svg>
                            </a>
                          </template>
                        </div>
                      </section>
                    </template>

                    <!-- Series seasons -->
                    <template x-if="type==='series'">
                      <section
                        id="seasonsSection"
                        class="mt-6 p-4 sm:p-5 rounded-2xl bg-surface border border-border"
                      >
                        <div class="flex items-center justify-between">
                          <h2 class="text-base font-bold">فصل‌ها و قسمت‌ها</h2>
                          <span
                            class="text-xs text-text-secondary"
                            x-text="seasons?.length ? (seasons.length + ' فصل') : ''"
                          ></span>
                        </div>

                        <template x-if="!seasons || !seasons.length">
                          <div
                            class="mt-4 text-sm text-text-secondary bg-surface-highlight/40 border border-border rounded-2xl p-4"
                          >
                            اطلاعات فصل‌ها در حال حاضر در دسترس نیست.
                          </div>
                        </template>

                        <template x-if="seasons && seasons.length">
                          <div
                            class="mt-4 space-y-3 max-h-[540px] overflow-y-auto custom-scrollbar pr-1"
                          >
                            <template
                              x-for="season in seasons"
                              :key="season.id || season.title"
                            >
                              <div
                                class="border border-border rounded-2xl overflow-hidden bg-surface-highlight/20"
                              >
                                <button
                                  type="button"
                                  @click="haptic('light'); toggleSeason(season.id)"
                                  class="w-full flex items-center justify-between px-4 py-3 bg-surface-highlight/40 hover:bg-surface-highlight transition-colors"
                                  :aria-label="'باز کردن ' + (season.title || 'فصل')"
                                >
                                  <div class="flex items-center gap-3 min-w-0">
                                    <span
                                      class="font-bold text-accent truncate"
                                      x-text="season.title || 'فصل'"
                                    ></span>
                                    <span
                                      class="text-xs text-text-secondary"
                                      x-text="season.episodes ? (season.episodes.length + ' قسمت') : ''"
                                    ></span>
                                  </div>
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 text-text-secondary transition-transform duration-300"
                                    :class="openSeasons.includes(season.id) ? 'rotate-90' : ''"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                    aria-hidden="true"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M9 5l7 7-7 7"
                                    />
                                  </svg>
                                </button>

                                <div
                                  x-show="openSeasons.includes(season.id)"
                                  x-collapse
                                  class="p-3 bg-surface"
                                >
                                  <div class="space-y-2">
                                    <template
                                      x-for="ep in (season.episodes || [])"
                                      :key="ep.id || ep.title"
                                    >
                                      <div
                                        class="rounded-2xl border border-border bg-surface-highlight/30 p-3"
                                      >
                                        <div
                                          class="flex items-center justify-between gap-3"
                                        >
                                          <div
                                            class="font-semibold truncate"
                                            x-text="ep.title || 'قسمت'"
                                          ></div>
                                          <div
                                            class="text-xs text-text-secondary shrink-0"
                                            x-text="ep.duration ? (ep.duration + ' دقیقه') : ''"
                                          ></div>
                                        </div>

                                        <template x-if="ep.description">
                                          <p
                                            class="mt-2 text-xs text-text-secondary leading-6 border-t border-border pt-2 whitespace-pre-line"
                                            x-text="ep.description"
                                          ></p>
                                        </template>

                                        <template
                                          x-if="ep.sources && ep.sources.length"
                                        >
                                          <div
                                            class="mt-3 pt-3 border-t border-border flex flex-wrap gap-2"
                                          >
                                            <template
                                              x-for="src in ep.sources"
                                              :key="src.id || src.url"
                                            >
                                              <a
                                                :href="src.url"
                                                target="_blank"
                                                rel="noopener"
                                                class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-accent text-accent-text text-xs font-bold hover:opacity-90 transition-opacity"
                                              >
                                                <svg
                                                  xmlns="http://www.w3.org/2000/svg"
                                                  class="h-4 w-4"
                                                  fill="none"
                                                  viewBox="0 0 24 24"
                                                  stroke="currentColor"
                                                  aria-hidden="true"
                                                >
                                                  <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                                                  />
                                                </svg>
                                                <span
                                                  x-text="src.quality || 'دانلود'"
                                                ></span>
                                              </a>
                                            </template>
                                          </div>
                                        </template>
                                      </div>
                                    </template>
                                  </div>
                                </div>
                              </div>
                            </template>
                          </div>
                        </template>
                      </section>
                    </template>
                  </div>
                </template>
              </div>
            </section>
          </main>
        </div>
      </div>

      <!-- Back to top: Desktop -->
      <button
        x-show="showBackToTop"
        @click="haptic('light'); window.scrollTo({ top: 0, behavior: 'smooth' })"
        x-transition
        class="hidden lg:flex fixed bottom-6 right-6 z-30 bg-accent text-accent-text p-3 rounded-full shadow-lg hover:scale-110 transition-transform motion-reduce:transition-none motion-reduce:transform-none"
        aria-label="بازگشت به بالا"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 15l7-7 7 7"
          ></path>
        </svg>
      </button>

      <!-- Back to top: Mobile -->
      <button
        x-show="showBackToTop"
        @click="haptic('light'); window.scrollTo({ top: 0, behavior: 'smooth' })"
        x-transition
        class="lg:hidden fixed right-6 z-30 bg-accent text-accent-text p-3 rounded-full shadow-lg hover:scale-110 transition-transform motion-reduce:transition-none motion-reduce:transform-none"
        style="bottom: calc(6.5rem + env(safe-area-inset-bottom))"
        aria-label="بازگشت به بالا"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 15l7-7 7 7"
          ></path>
        </svg>
      </button>

      <!-- Toast (kept for watchlist actions; NOT for theme) -->
      <div
        class="hidden lg:block fixed left-1/2 -translate-x-1/2 bottom-6 z-50 pointer-events-none"
        aria-live="polite"
        aria-atomic="true"
      >
        <div
          x-show="toast.show"
          x-transition
          x-cloak
          class="pointer-events-auto max-w-sm rounded-2xl border border-border bg-surface/90 backdrop-blur-xl px-4 py-3 shadow-2xl"
        >
          <div
            class="text-sm font-semibold text-center"
            x-text="toast.message"
          ></div>
        </div>
      </div>

      <div
        class="lg:hidden fixed left-1/2 -translate-x-1/2 z-50 pointer-events-none"
        style="bottom: calc(6.5rem + env(safe-area-inset-bottom))"
        aria-live="polite"
        aria-atomic="true"
      >
        <div
          x-show="toast.show"
          x-transition
          x-cloak
          class="pointer-events-auto max-w-sm rounded-2xl border border-border bg-surface/90 backdrop-blur-xl px-4 py-3 shadow-2xl"
        >
          <div
            class="text-sm font-semibold text-center"
            x-text="toast.message"
          ></div>
        </div>
      </div>

      <!-- Floating Bottom Action Bar (Mobile) -->
      <nav class="lg:hidden fixed bottom-0 left-0 right-0 z-40">
        <div
          class="px-4 pb-4"
          style="padding-bottom: calc(env(safe-area-inset-bottom) + 1rem)"
        >
          <div
            class="mx-auto max-w-xs rounded-[35px] border border-border/60 bg-surface/70 backdrop-blur-xs shadow-2xl"
          >
            <div class="flex items-center justify-between px-3 py-2 gap-2">
              <button
                type="button"
                @click="haptic('light'); goBack()"
                class="flex-1 py-2 flex flex-col items-center justify-center gap-1 text-text-secondary hover:text-text-primary transition-colors"
                aria-label="بازگشت"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="size-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M17 8l4 4m0 0l-4 4m4-4H3"
                  />
                </svg>
                <span class="text-[11px] leading-none font-semibold"
                  >بازگشت</span
                >
              </button>

              <!-- ✅ Improved My List (no dot, clearer CTA) -->
              <button
                type="button"
                @click="haptic('light'); item && toggleWatchlist(item.id)"
                class="flex-1 py-2 flex flex-col items-center justify-center gap-1 transition-colors"
                :class="item && isInWatchlist(item.id) ? 'text-accent' : 'text-text-secondary hover:text-text-primary'"
                :disabled="!item"
                :aria-label="item && isInWatchlist(item.id) ? 'حذف از لیست من' : 'افزودن به لیست من'"
              >
                <div class="relative">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="size-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    aria-hidden="true"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z"
                    />
                  </svg>
                  <span
                    x-show="item && !isInWatchlist(item.id)"
                    x-cloak
                    class="absolute -top-1.5 -left-1.5 px-1.5 py-0.5 rounded-full bg-accent text-accent-text text-[9px] font-bold"
                    >+</span
                  >
                </div>

                <span
                  class="text-[11px] leading-none font-semibold"
                  x-text="item && isInWatchlist(item.id) ? 'در لیست شما' : 'افزودن به لیست'"
                ></span>
              </button>

              <button
                type="button"
                @click="haptic('light'); scrollToPrimarySection()"
                class="flex-[1.2] py-2 flex flex-col items-center justify-center gap-1 text-accent"
                :disabled="!item"
                :aria-label="type==='series' ? 'رفتن به فصل‌ها' : 'رفتن به دانلود'"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="size-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 6v12m6-6H6"
                  />
                </svg>
                <span
                  class="text-[11px] leading-none font-semibold"
                  x-text="type==='series' ? 'فصل‌ها' : 'دانلود'"
                ></span>
              </button>
            </div>
          </div>
        </div>
      </nav>

      <footer class="w-full py-8 mt-auto border-t border-border bg-bg">
        <div
          class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center gap-4"
        >
          <p class="text-sm text-text-secondary">
            &copy; <span x-text="new Date().getFullYear()"></span> ببینتو. تمامی
            حقوق محفوظ است.
          </p>
        </div>
      </footer>
    </div>

    <script>
      function BebintoDetailsApp() {
        return {
          baseUrl: "https://bebinto-core.aryazdh.ir",
          apiPrefix: "/api/v1",

          theme: "dark",
          showBackToTop: false,

          loading: true,
          error: "",

          item: null,
          type: "movie",

          seasons: [],
          openSeasons: [],

          watchlist: [],

          toast: { show: false, message: "" },
          toastTimer: null,

          // Poster skeleton + fallback
          posterLoaded: false,
          posterSrc: "./placeholder.png",
          _posterFallbackUsed: false,

          // Hero background "feel"
          heroLoaded: false,
          heroSrc: "",

          init() {
            this.loadTheme();
            this.loadWatchlist();
            this.fetchData();
          },

          // UI
          haptic(level = "light") {
            try {
              if (!navigator.vibrate) return;
              const ms = level === "heavy" ? 30 : level === "medium" ? 20 : 10;
              navigator.vibrate(ms);
            } catch (e) {}
          },

          showToast(msg) {
            this.toast.message = msg;
            this.toast.show = true;
            clearTimeout(this.toastTimer);
            this.toastTimer = setTimeout(() => (this.toast.show = false), 1800);
          },

          handleEscape() {},

          // Theme (no toast)
          applyThemeClass() {
            const el = document.documentElement;
            el.classList.remove("light", "dark");
            el.classList.add(this.theme);
          },

          loadTheme() {
            const saved = localStorage.getItem("cinemaplus-theme");
            this.theme = saved === "light" || saved === "dark" ? saved : "dark";
            this.applyThemeClass();
          },

          toggleTheme() {
            this.theme = this.theme === "dark" ? "light" : "dark";
            localStorage.setItem("cinemaplus-theme", this.theme);
            this.applyThemeClass();
          },

          // Query & nav
          getQueryParam(name) {
            return new URLSearchParams(window.location.search).get(name);
          },

          goBack() {
            try {
              if (
                document.referrer &&
                document.referrer.includes(window.location.hostname)
              )
                history.back();
              else window.location.href = "./index.html";
            } catch (e) {
              window.location.href = "./index.html";
            }
          },

          get isMovie() {
            return this.type === "movie";
          },

          scrollToPrimarySection() {
            if (this.type === "series") {
              const el = document.getElementById("seasonsSection");
              if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
              else
                window.scrollTo({
                  top: document.body.scrollHeight,
                  behavior: "smooth",
                });
            } else {
              const el = document.getElementById("downloadsSection");
              if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
              else
                window.scrollTo({
                  top: document.body.scrollHeight,
                  behavior: "smooth",
                });
            }
          },

          // Hero background style
          heroBackdropStyle() {
            if (!this.heroLoaded || !this.heroSrc) return "";
            return `background-image:url('${this.heroSrc}')`;
          },

          // =========================
          // Watchlist
          // =========================
          loadWatchlist() {
            try {
              const list = localStorage.getItem("cinemaWatchlist");
              this.watchlist = list ? JSON.parse(list) : [];
            } catch (e) {
              this.watchlist = [];
            }
          },

          saveWatchlist() {
            localStorage.setItem(
              "cinemaWatchlist",
              JSON.stringify(this.watchlist)
            );
          },

          isInWatchlist(id) {
            if (!id) return false;
            return this.watchlist.includes(id);
          },

          toggleWatchlist(id) {
            if (!id) return;

            const wasIn = this.isInWatchlist(id);
            if (wasIn)
              this.watchlist = this.watchlist.filter((itemId) => itemId !== id);
            else this.watchlist.push(id);

            this.saveWatchlist();
            this.showToast(
              wasIn ? "از لیست شما حذف شد" : "به لیست شما اضافه شد"
            );
          },

          // =========================
          // ✅ Poster loader (FIXED)
          // =========================
          setPoster(src) {
            const finalSrc =
              src && String(src).trim() ? src : "./placeholder.png";

            this._posterFallbackUsed = false;
            this.posterLoaded = false;
            this.posterSrc = finalSrc;

            // مهم: اگر عکس از cache لود شده باشد، event load ممکن است سریع/نامطمئن باشد.
            // پس بعد از رندر شدن، complete را چک می‌کنیم.
            this.$nextTick(() => {
              const img = this.$refs?.posterImg;
              if (!img) return;

              // اگر همین الان لود شده بود (cached)
              if (img.complete && img.naturalWidth > 0) {
                this.posterLoaded = true;
              }
            });
          },

          handlePosterLoad() {
            this.posterLoaded = true;
          },

          handlePosterError() {
            // یکبار fallback کن، بعدش دیگه loop نشه
            if (this._posterFallbackUsed) {
              this.posterLoaded = true; // shimmer رو بردار
              return;
            }
            this._posterFallbackUsed = true;

            // رفتن روی placeholder
            this.posterLoaded = false;
            this.posterSrc = "./placeholder.png";

            this.$nextTick(() => {
              const img = this.$refs?.posterImg;
              if (!img) return;

              if (img.complete && img.naturalWidth > 0) {
                this.posterLoaded = true;
              }
            });
          },

          // =========================
          // ✅ Hero preload
          // =========================
          preloadHero(src) {
            this.heroLoaded = false;
            this.heroSrc = "";

            const candidate = src && String(src).trim() ? src : "";
            if (!candidate) {
              this.heroLoaded = true;
              return;
            }

            const img = new Image();
            img.onload = () => {
              this.heroSrc = candidate;
              this.heroLoaded = true;
            };
            img.onerror = () => {
              const fallback = "./placeholder.png";

              // اگر خود fallback هم خطا داد، فقط bg نذار
              if (candidate === fallback) {
                this.heroSrc = "";
                this.heroLoaded = true;
                return;
              }

              const img2 = new Image();
              img2.onload = () => {
                this.heroSrc = fallback;
                this.heroLoaded = true;
              };
              img2.onerror = () => {
                this.heroSrc = "";
                this.heroLoaded = true;
              };
              img2.src = fallback;
            };

            img.src = candidate;
          },

          // =========================
          // Network
          // =========================
          async fetchJson(url) {
            const res = await fetch(url, {
              headers: { Accept: "application/json" },
            });
            if (!res.ok) throw new Error("Network error");
            return res.json();
          },

          normalizeArr(v) {
            return Array.isArray(v) ? v : [];
          },

          normalizeDetailsPayload(payload) {
            const p = payload || {};

            const t = String(p.type || "").toLowerCase();
            const finalType =
              t === "series" || t === "serie" ? "series" : "movie";

            let duration = p.duration;
            if (typeof duration === "string") duration = duration.trim();
            if (!duration || duration === "N/A") duration = null;

            let durationText = duration;
            if (typeof durationText === "string") {
              const m = durationText.match(/(\d+)\s*min/i);
              if (m) durationText = `${m[1]} دقیقه`;
            }

            const country = this.normalizeArr(p.country);
            const genres = this.normalizeArr(p.genres);
            const sources = this.normalizeArr(p.sources);
            const seasons = this.normalizeArr(p.seasons);

            const normSeasons = seasons.map((s) => ({
              ...s,
              episodes: this.normalizeArr(s?.episodes).map((ep) => ({
                ...ep,
                sources: this.normalizeArr(ep?.sources),
              })),
            }));

            const countryText = country
              .map((c) => c?.title ?? c)
              .filter(Boolean)
              .join("، ");
            const genresText = genres.map((g) => g?.title ?? g).filter(Boolean);

            return {
              ...p,
              type: finalType,
              duration,
              durationText,
              country,
              genres,
              sources,
              seasons: normSeasons,
              _countryText: countryText,
              _genresText: genresText,
            };
          },

          async fetchData() {
            this.loading = true;
            this.error = "";
            this.item = null;
            this.seasons = [];
            this.openSeasons = [];

            // ✅ ریست‌های ظاهری (بدون flicker)
            this.posterLoaded = false;
            this.heroLoaded = false;

            const id = this.getQueryParam("id");
            const qt = this.getQueryParam("type");
            this.type = qt === "series" ? "series" : "movie";

            if (!id) {
              this.error =
                "شناسه آیتم نامعتبر است. لطفاً از صفحه اصلی یک عنوان را انتخاب کنید.";
              this.loading = false;
              return;
            }

            try {
              const url = `${this.baseUrl}${
                this.apiPrefix
              }/details?id=${encodeURIComponent(id)}&type=${encodeURIComponent(
                this.type
              )}`;
              const json = await this.fetchJson(url);

              const details = this.normalizeDetailsPayload(json?.data);
              if (!details?.id) throw new Error("Invalid details payload");

              // ✅ ست کردن item اول (برای متن/اطلاعات)
              this.item = details;
              this.type = details.type;

              if (this.type === "series") this.seasons = details.seasons || [];

              // ✅ Poster + Hero بعد از اینکه refs آماده شد
              const posterCandidate =
                details?.image || details?.cover || "./placeholder.png";
              this.setPoster(posterCandidate);

              const heroCandidate = details?.cover || details?.image || "";
              this.preloadHero(heroCandidate);

              try {
                localStorage.setItem(
                  "cinemaplus-last-item",
                  JSON.stringify(details)
                );
              } catch (e) {}
            } catch (e) {
              this.error = "خطا در دریافت جزئیات. لطفاً دوباره تلاش کنید.";
            } finally {
              this.loading = false;
            }
          },

          // =========================
          // Seasons
          // =========================
          toggleSeason(id) {
            if (!id) return;
            if (this.openSeasons.includes(id))
              this.openSeasons = this.openSeasons.filter((s) => s !== id);
            else this.openSeasons.push(id);
          },

          // =========================
          // Description parsing
          // =========================
          parseDescription(desc = "") {
            const parts = String(desc)
              .split(/\r?\n\r?\n/)
              .map((p) => p.trim())
              .filter(Boolean);

            const plotIndex = parts.findIndex(
              (p) => p.startsWith("خلاصه داستان") || p.startsWith("خلاصه سریال")
            );
            if (plotIndex !== -1) {
              return {
                meta: parts.slice(0, plotIndex),
                plot: parts.slice(plotIndex + 1).join("\n\n"),
              };
            }
            return { meta: [], plot: desc };
          },

          metaLines(item) {
            return item?.description
              ? this.parseDescription(item.description).meta
              : [];
          },

          plotText(item) {
            if (!item) return "";
            if (item.plot) return item.plot;
            if (item.description) {
              const { plot } = this.parseDescription(item.description);
              return plot || item.description;
            }
            return "خلاصه‌ای برای این عنوان ثبت نشده است.";
          },

          // Display helpers
          displayTitle(item) {
            return item?.title || item?.name || "بدون عنوان";
          },

          displayCountry(item) {
            if (!item) return "";
            return item._countryText || "";
          },

          displayGenres(item) {
            if (!item) return [];
            return Array.isArray(item._genresText)
              ? item._genresText.slice(0, 6)
              : [];
          },
        };
      }
    </script>
  </body>
</html>
